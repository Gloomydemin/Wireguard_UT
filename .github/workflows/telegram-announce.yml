name: Telegram release announce

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      title:
        description: "Title"
        required: false
      message:
        description: "Message body"
        required: false
      url:
        description: "Link"
        required: false

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram message
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          RELEASE_TITLE: ${{ github.event.release.name }}
          RELEASE_URL: ${{ github.event.release.html_url }}
          INPUT_TITLE: ${{ github.event.inputs.title }}
          INPUT_MESSAGE: ${{ github.event.inputs.message }}
          INPUT_URL: ${{ github.event.inputs.url }}
        run: |
          if [ -z "$BOT_TOKEN" ] || [ -z "$CHAT_ID" ]; then
            echo "Missing TELEGRAM_BOT_TOKEN or TELEGRAM_CHAT_ID"
            exit 1
          fi

          TITLE="${INPUT_TITLE:-${RELEASE_TITLE:-$RELEASE_TAG}}"
          MSG="${INPUT_MESSAGE:-New release available.}"
          URL="${INPUT_URL:-$RELEASE_URL}"

          TEXT="$TITLE\n$MSG"
          if [ -n "$URL" ]; then
            TEXT="$TEXT\n$URL"
          fi

          curl -sS -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="$CHAT_ID" \
            -d text="$TEXT" >/dev/null
